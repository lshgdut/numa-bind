<!DOCTYPE html>
<html>
<head>
    <title>test</title>
    <style type="text/css">
        canvas{margin: 100px;border:0px solid #f0f;box-sizing: border-box;}
    </style>

</head>
<body>
    <!-- <script type="text/javascript" src="const.js"></script> -->
    <script type="text/javascript">
        const SPEED_UP = 60
        const SOCKET_CNT = 4
        const CORE_PER_SOCKET = 1
        const SIZE_PER_SOCKET = 100
        const GRID_LINE_WIDTH = 1
        const GRID_LINE_COLOR = '#999'
        const GRID_MAP = {
            "1" : 1,
            "2" : 2,
            "4" : 2,
            "8" : 4,
            "16" : 4,
            "32" : 8
        }

        COLORS = ['#2f7ed8', '#0d233a', '#8bbc21', '#910000', '#1aadce', '#492970', '#f28f43', '#77a1e5', '#c42525', '#a6c96a']

        const numa_task_list = [
        {id: '1', name: 'mcf',      recv_time: '09:00:00', start_time: '09:00:00', end_time: '09:04:26', socket_id: "1", core_id: "1"},
        {id: '2', name: 'milc',     recv_time: '09:00:00', start_time: '09:00:20', end_time: '09:07:48', socket_id: "3", core_id: "1"},
        {id: '3', name: 'leslie3d', recv_time: '09:00:00', start_time: '09:00:40', end_time: '09:06:11', socket_id: "2", core_id: "1"},
        {id: '4', name: 'namd',     recv_time: '09:00:00', start_time: '09:01:00', end_time: '09:08:37', socket_id: "4", core_id: "1"},
        {id: '5', name: 'bzip2',    recv_time: '09:00:00', start_time: '09:04:26', end_time: '09:14:48', socket_id: "1", core_id: "1"},
        {id: '6', name: 'gobmk',    recv_time: '09:00:00', start_time: '09:06:11', end_time: '09:15:51', socket_id: "2", core_id: "1"},
        ]

        const mcore_task_list = [
        {id: '1', name: 'mcf',      recv_time: '09:00:00', start_time: '09:00:00', end_time: '09:04:46', socket_id: "1", core_id: "1"},
        {id: '2', name: 'milc',     recv_time: '09:00:00', start_time: '09:00:20', end_time: '09:08:28', socket_id: "2", core_id: "1"},
        {id: '3', name: 'leslie3d', recv_time: '09:00:00', start_time: '09:00:40', end_time: '09:06:07', socket_id: "3", core_id: "1"},
        {id: '4', name: 'namd',     recv_time: '09:00:00', start_time: '09:01:00', end_time: '09:08:37', socket_id: "4", core_id: "1"},
        {id: '5', name: 'bzip2',    recv_time: '09:00:00', start_time: '09:04:46', end_time: '09:15:06', socket_id: "1", core_id: "1"},
        {id: '6', name: 'gobmk',    recv_time: '09:00:00', start_time: '09:06:07', end_time: '09:15:56', socket_id: "3", core_id: "1"},
        ]

        const log = console.log
        const cvs = document.createElement('canvas')
        cvs.id='canvas'
        // cols
        const cols = GRID_MAP[SOCKET_CNT]
        const rows = SOCKET_CNT / cols
        const cvsWidth = cvs.width = cols * SIZE_PER_SOCKET + (cols + 1) * GRID_LINE_WIDTH
        const cvsHeight = cvs.height = cvs.width

        document.body.appendChild(cvs)
        const ctx = cvs.getContext('2d')
        ctx.lineWidth = GRID_LINE_WIDTH


        class Task{
            constructor(ctx, cfg, baseTime){
                cfg = cfg || {}
                // this.x = cfg.x
                // this.y = cfg.y
                // this.size = cfg.size
                this.baseTime = baseTime
                this.core_id = cfg.core_id * 1
                this.socket_id = cfg.socket_id * 1
                this.id = cfg.id
                this.name = cfg.name
                this.color = this._gen_color()
                this.recv_time = cfg.recv_time
                this.start_time = cfg.start_time
                this.end_time = cfg.end_time

                this.colIndex = Math.floor((this.socket_id - 1) / rows)
                this.rowIndex = (this.socket_id - 1) % cols
                console.log('%s, %s, %s, %s', this.name, this.colIndex, this.rowIndex, this.socket_id)
                this.ctx = ctx
            }

            getXY() {
                let colIndex = this.colIndex
                let x = (colIndex + 1) * GRID_LINE_WIDTH + colIndex * this.getSize()

                let rowIndex = this.rowIndex
                let y = (rowIndex + 1) * GRID_LINE_WIDTH + rowIndex * this.getSize()

                return [x, y]
            }

            getSize() {
                return SIZE_PER_SOCKET
            }

            _gen_color(){
                return COLORS[ (this.id - 1) % COLORS.length]
            }

            isExpired() {
                let now = Date.now() - this.baseTime
                let isExpired = this.end_time < now
                return isExpired
            }

            isRunning() {
                let now = Date.now() - this.baseTime
                let isRunning = this.end_time >= now && now >= this.start_time
                return isRunning
            }

            draw(){
                if (!this.isRunning()) {
                    return false
                }

                this.ctx.save()
                this.ctx.fillStyle = this.color

                let xy = this.getXY()
                let size = this.getSize()
                this.ctx.fillRect(xy[0], xy[1], size, size)

                this.ctx.restore()

                // console.log('draw %s at %s', this.name, xy.join(','))
                return true
            }

        }

        const each_ctx_rows = (fn) => {
            for (let i=0;i<cvsHeight;i+=(SIZE_PER_SOCKET+GRID_LINE_WIDTH)) {
                fn(i + 0.5)
            }
        }
        const each_ctx_cols = (fn) => {
            for (let i=0;i<cvsWidth;i+=(SIZE_PER_SOCKET+GRID_LINE_WIDTH)) {
                fn(i + 0.5)
            }
        }

        const _convert_time = time => {
            let times = time.match(/^(\d\d):(\d\d):(\d\d)$/).slice(1,4).map(Number)
            return (times[0] * 3600 + times[1] * 60 + times[2]) * 1000
        }


        const env_base_time = Date.now()

        var task_pool = []
        var tasks_base_time = Number.MAX_VALUE
        numa_task_list.forEach((item)=>{
            item.recv_time = _convert_time(item.recv_time)
            item.start_time = _convert_time(item.start_time)
            item.end_time = _convert_time(item.end_time)

            tasks_base_time = Math.min(tasks_base_time, item.recv_time)
        })

        numa_task_list.forEach((item)=>{
            item.recv_time = Math.ceil((item.recv_time - tasks_base_time) / SPEED_UP)
            item.start_time = Math.ceil((item.start_time - tasks_base_time) / SPEED_UP)
            item.end_time = Math.ceil((item.end_time - tasks_base_time) / SPEED_UP)
        })

        numa_task_list.forEach((item)=>{
            let task = new Task(ctx, item, env_base_time)
            task_pool.push(task)
        })

        function draw_gridline() {
            ctx.save()
            ctx.strokeStyle = GRID_LINE_COLOR
            
            // draw ver lines
            each_ctx_cols((i) => {
                ctx.moveTo(i, 0)
                ctx.lineTo(i, cvsHeight)
                ctx.stroke()
            })

            // draw hoz lines
            each_ctx_rows((i) => {
                ctx.moveTo(0, i)
                ctx.lineTo(cvsHeight, i)
                ctx.stroke()
            })

            ctx.restore()
        }

        function draw_tasks() {
            let a = 1
            task_pool = task_pool.filter(task => {
                task.draw()
                return !task.isExpired()
            })

            return task_pool.length
        }

        (function repaint() {
            ctx.clearRect(0, 0, cvsWidth, cvsHeight)
            draw_gridline()
            let cont = draw_tasks()

            cont && requestAnimationFrame(repaint)
        })()
    </script>
</body>
</html>